# Алгоритмы анализа финансовых данных

## 1. Статистика по периодам

**Метод:** `GetStatistics`

Агрегирует транзакции пользователя за указанный период с группировкой по временным интервалам (месяц/квартал/год).

**Выход:**

- Доходы и расходы по периодам
- Баланс за каждый период
- Разбивка по категориям (MCC)

## 2. Прогнозирование (WMA - Weighted Moving Average)

**Метод:** `GetForecast`

**Алгоритм:**

1. Берет N последних периодов (по умолчанию 6)
2. Применяет взвешенное скользящее среднее с линейными весами
3. Веса: последнему периоду присваивается максимальный вес N, предпоследнему N-1, и т.д.
4. Формула: `Прогноз = Σ(Значение[i] × Вес[i]) / Σ(Вес[i])`

**Параметры:**

- `lookback_periods` - количество периодов для анализа (по умолчанию 6)
- `max_periods_ahead` - максимальное количество периодов для прогноза (по умолчанию 12)

**Преимущества WMA:**

- Большее влияние недавних данных
- Быстрая адаптация к трендам
- Низкая вычислительная сложность

## 3. Детекция аномалий

**Метод:** `GetAnomalies`

**Алгоритм:**

1. Анализирует траты по категориям (MCC) за последние N периодов
2. Для каждой категории рассчитывает ожидаемую сумму через WMA
3. Сравнивает фактическую сумму с ожидаемой
4. Аномалия детектируется если: `|Факт - Ожидание| / Ожидание × 100 > Порог`

**Параметры:**

- `lookback_periods` - количество периодов для анализа (по умолчанию 6)
- `deviation_threshold` - порог отклонения в процентах (по умолчанию 50%)
- `new_category_threshold` - минимальная сумма для новой категории (по умолчанию 50000)

**Типы аномалий:**

- Превышение среднего уровня трат в категории
- Появление новой категории с большой суммой

**Выход:**

- Категории с аномалиями, отсортированные по величине отклонения
- Фактическая и ожидаемая суммы
- Абсолютное отклонение

## 4. Детекция регулярных платежей

**Метод:** `GetUpcomingRecurring`

**Алгоритм:**

1. Анализирует транзакции за последние N месяцев
2. Группирует по категориям (MCC)
3. Для каждой категории:
   - Подсчитывает количество транзакций
   - Вычисляет медианную сумму
   - Рассчитывает средний интервал между платежами
4. Паттерн считается регулярным если:
   - Минимум M транзакций
   - Интервал между платежами в диапазоне [MIN_DAYS, MAX_DAYS]
   - Отклонение дат от среднего ≤ DEVIATION_DAYS
5. Предсказывает следующую дату платежа: `Последний_платеж + Средний_интервал`

**Параметры:**

- `lookback_months` - глубина анализа в месяцах (по умолчанию 6)
- `min_occurrences` - минимальное число повторений (по умолчанию 3)
- `interval_min_days` - минимальный интервал в днях (по умолчанию 25)
- `interval_max_days` - максимальный интервал в днях (по умолчанию 35)
- `date_deviation_days` - допустимое отклонение дат (по умолчанию 3)
- `prediction_days` - окно предсказания в днях (по умолчанию 30)

**Выход:**

- Список ожидаемых платежей в окне предсказания
- Типичная сумма (медиана)
- Ожидаемая дата
- Отсортировано по дате

## Конфигурация

Все параметры алгоритмов настраиваются через `config.yaml`:

```yaml
analytics:
  forecast:
    lookback_periods: 6
    max_periods_ahead: 12
  anomaly:
    lookback_periods: 6
    deviation_threshold: 50.0
    new_category_threshold: 50000
  recurring:
    lookback_months: 6
    min_occurrences: 3
    interval_min_days: 25
    interval_max_days: 35
    date_deviation_days: 3
    prediction_days: 30
```

## Требования к данным

**Минимальные требования:**

- Прогнозирование: минимум 2 периода исторических данных
- Детекция аномалий: минимум 2 периода исторических данных
- Регулярные платежи: минимум 3 транзакции в категории

**Рекомендуемые:**

- Для точного прогноза: 6+ месяцев данных
- Для детекции аномалий: 6+ периодов
- Для регулярных платежей: 6+ месяцев истории
